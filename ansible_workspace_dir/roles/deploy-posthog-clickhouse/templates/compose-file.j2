version: '3.7'

services:
  {{ docker_service_name }}:
    image: {{ docker_hub_url }}/{{ image_name }}:{{ tag }}
    hostname: "{{ docker_service_name }}"
    restart: always
    volumes:
      - clickhouse-data:/var/lib/clickhouse
    depends_on:
      - {{ docker_service_name }}_kafka
      - {{ docker_service_name }}_zookeeper
    networks:
      application_default:
        aliases:
            - {{ network_alias_name }}

    env_file:
      - {{ env_file_deployment_location }}

  {{ docker_service_name }}_zookeeper:
    hostname: {{ docker_service_name }}_zookeeper
    image: zookeeper:3.7.0
    restart: always
    volumes:
      - zookeeper-datalog:/datalog
      - zookeeper-data:/data
      - zookeeper-logs:/logs
    networks:
      application_default:
        aliases:
            - {{ network_alias_name }}

  {{ docker_service_name }}_kafka:
    image: bitnami/kafka:2.8.1-debian-10-r99
    hostname: "{{ docker_service_name }}_kafka"
    restart: always
    depends_on:
      - {{ docker_service_name }}_zookeeper
    environment:
      KAFKA_BROKER_ID: 1001
      KAFKA_CFG_RESERVED_BROKER_MAX_ID: 1001
      KAFKA_CFG_LISTENERS: PLAINTEXT://:9092
      KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://{{ docker_service_name }}_kafka:9092
      KAFKA_CFG_ZOOKEEPER_CONNECT: {{ docker_service_name }}_zookeeper:2181
      ALLOW_PLAINTEXT_LISTENER: 'true'

    networks:
      application_default:
        aliases:
            - {{ network_alias_name }}

networks:
  application_default:
    external: true

volumes:
  clickhouse-data:
  zookeeper-datalog:
  zookeeper-data:
  zookeeper-logs: